const fs=require("fs");const path=require("path");module.exports={initBackup(){this.backupStates=["devices","layout","widgets","settings","css","scripts"];this.backups={}},getBackupFile(t){return path.join(__dirname,"..","..","..","iobroker-data","jarvis",this.adapter.instance.toString(),t+".json")},loadBackups(){this.backupStates.forEach(t=>{const a="jarvis."+this.adapter.instance+"."+t;const i=this.getBackupFile(a);fs.readFile(i,(t,s)=>{const e=path.dirname(i);if(!fs.existsSync(e)){fs.mkdirSync(e,{recursive:true})}if(t){this.adapter.log.debug("No Backup found for "+a+", thus backing up initially.");this.adapter.getState(a,(t,s)=>!t&&s&&s.val&&this.backup(a,s.val))}else if(s){this.adapter.log.debug("Found Backups for "+a+".");try{this.backups[a]=JSON.parse(s)}catch(t){this.adapter.log.error("Error loading recent backups ("+a+"): "+t.message)}}})});return this},isBackupState(s){return s.startsWith("jarvis.")&&this.backupStates.some(t=>s.endsWith("."+t))},getBackupList(t){this.adapter.log.debug("Get List of Backups for "+t+".");return this.backups[t]},restore(t,s){if(this.backups[t]&&this.backups[t][s]){this.adapter.log.info("Restore "+t+" from "+s+"...");this.adapter.setState(t,this.backups[t][s],true)}else{this.adapter.log.warn("Restore "+t+": Date "+s+" not found!")}},backup(e,t){if(!t||t&&t.toString()==="{}"||!this.isBackupState(e)){return false}const s=new Date;const a=s.getFullYear()+"-"+("0"+(s.getMonth()+1)).substr(-2)+"-"+("0"+s.getDate()).substr(-2)+"_"+("0"+s.getHours()).substr(-2)+"-"+("0"+s.getMinutes()).substr(-2)+"-"+("0"+s.getSeconds()).substr(-2);this.backups[e]=this.backups[e]||{};this.backups[e][a]=t;const i=(this.adapter.config.keepBackupEntries||25)-1;const r=Object.keys(this.backups[e]);if(r.length>i){r.reverse().forEach((t,s)=>{if(s>i){delete this.backups[e][t]}})}const u=this.getBackupFile(e);this.adapter.log.info("Backup "+e+' to "'+u+'"...');return fs.writeFile(u,JSON.stringify(this.backups[e],null,3),t=>t&&this.adapter.log.error("Error saving backups to storage: "+t.message))}};