const{BindToClass}=require("./helpers");const platform=require("platform");const rfdc=require("rfdc/default");const uuid=require("uuid").v5;const EventEmitter=require("events");class JarvisClient extends EventEmitter{constructor(s,t){super();BindToClass(rfdc(t),this);this.adapter=s;this.instances={}}static getClientInformation({userAgent:s,remoteAddress:t,clientId:i,...e}){const n=platform.parse(s);const c=n.name||"";const r=t.indexOf(":")!==-1?t.substr(t.lastIndexOf(":")+1):t;const d=(r?r.replace(/\./g,"-"):"no-ip-detected")+"_"+(c?c.replace(/ /g,"-"):"no-browser-detected");const a=null;return{...e,id:i||uuid(d,"d03b9915-564d-491e-a0e0-7ef4af0a52d1"),ip:r,lastActivity:Date.now(),ns:d,unreadNotifications:[],userAgent:s,userBrowser:c,userId:a,userPlatform:n||{}}}addInstance(t,s){if(!this.instances[t]){this.instances[t]=s;this.adapter.log.info((this.remoteId?"Remote-":"")+'Client-Instance with ip "'+this.ip+'" (client-id "'+this.id+'") and instance-id "'+t+'" (using '+this.userBrowser+") connected (with "+Object.keys(this.instances).length+" instances in total).");if(!this.remoteId){this.instances[t].on("close",()=>this.disconnect(t));this.instances[t].on("message",s=>this.message(t,s))}}return this}message(s,t){this.adapter.log.silly('Received message from client-instance "'+s+'"  (client-id "'+this.id+'"): '+JSON.stringify(t));this.emit("message",s,t)}disconnect(s,t=null){if(this.instances[s]){this.instances[s].close();delete this.instances[s]}if(Object.keys(this.instances).length===0){for(const i in this.subscribedStates){if(this.subscribedStates[i][this.id]){delete this.subscribedStates[i][this.id]}}for(const e in this.subscribedHistory){if(this.subscribedHistory[e].clients&&this.subscribedHistory[e].clients.includes(this.id)){this.subscribedHistory[e].clients=this.subscribedHistory[e].clients.filter(s=>s.id!==this.id)}}for(const e in this.subscribedCalendar){if(this.subscribedCalendar[e].clients&&this.subscribedCalendar[e].clients.includes(this.id)){this.subscribedCalendar[e].clients=this.subscribedCalendar[e].clients.filter(s=>s.id!==this.id)}}if(this.subscribedLog&&this.subscribedLog[this.id]){delete this.subscribedLog[this.id]}this.emit("disconnected",t)}this.adapter.log.info((this.remoteId?"Remote-":"")+'Client-Instance with ip "'+this.ip+'" (client-id "'+this.id+'") and instance-id "'+s+'" disconnected (with '+Object.keys(this.instances).length+" instances left in total)"+(t?": "+t:"."));return this}send(i,t,...e){let s=null;try{s=JSON.parse(i.chunk).stateId}catch(s){}try{this.adapter.log.silly("Send message to "+JSON.stringify(t)+" with params "+JSON.stringify(e)+": "+i.action+(s?' "'+s+'"':"")+".");if(t.instanceId){const n=this.instances[t.instanceId];n&&n.send(JSON.stringify(i),...e)}else{Object.keys(this.instances).forEach(s=>{const t=this.instances[s];t&&t.send(JSON.stringify(i),...e)})}}catch(s){this.adapter.log.warn('Error sending message to client with ip "'+this.ip+'" (client-id "'+this.id+'") ('+(t.instanceId?'for instance "'+t.instanceId+'"':"for all instances")+', action "'+i.action+'"): '+s.message)}}}module.exports=JarvisClient;