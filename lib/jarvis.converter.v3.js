const{hash}=require("./helpers");module.exports={v2css(s,o){return new Promise((i,n)=>{this.adapter.getObject(o._id,(e,t)=>{if(e){return n(e)}this.adapter.setObject(o._id,{...t,common:{...t.common,role:"json"}},()=>{this.adapter.setState(o._id,JSON.stringify({version:3.2,signature:hash(o.val),[s==="css"?"styles":s]:o.val},null,3),true,()=>i({key:s,version:3.2}))})})})},v2scripts(e,t){return this.v2css(e,t)},v2devices(n,e){const o=e.val||{};let a={};Object.keys(o).forEach(e=>{const t=o[e];const i={};for(const n in t.states){const s=t.states[n];if(s.label||s.state||s.action){i[n]={showState:(s.state&&s.state.node||typeof s.state==="string")&&(s.actionElement===undefined||s.actionElement===null||s.actionElement==="State"),...s,state:s.state&&s.state.node!==undefined?s.state.node:s.state||"",action:s.action&&s.action.node!==undefined?s.action.node:s.action||""};if(i[n].bodyElement!==null){i[n].bodyElement=i[n].bodyElement==="LightTemperatureBody"?"LevelBody":i[n].bodyElement}}}if(t.suppressPopup!==undefined){t.options.suppressPopup=t.suppressPopup;delete t.suppressPopup}delete t.hash;t.states=i;a[e]=t});return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3,signature:hash(a),devices:a}),true,e=>e?i({key:n,version:2}):t({key:n,version:3}))})},v3devices(n,e){const i=e.val&&e.val.devices||{};let s={};Object.keys(i).forEach(e=>{const t=i[e];if(t.attributes&&t.attributes.manufacturer&&t.attributes.manufacturer.namespace){t.tags=t.tags||[];if(!t.tags.includes(t.attributes.manufacturer.namespace)){t.tags.push(t.attributes.manufacturer.namespace)}delete t.attributes.manufacturer}s[e]=t});return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3.2,signature:hash(s),devices:s}),true,e=>e?i({key:n,version:2}):t({key:n,version:3.2}))})},v2layout(n,e){const t=e.val||[];let c=[];const m={};t.forEach((e,u)=>{c[u]={id:uuid(),title:e.title||i18n.global.t("Main Site"),type:"page",icon:"mdi-file",iconColor:"",color:"",backgroundColor:"",hideLabels:e.hideLabels!==undefined?e.hideLabels:false,tabs:[]};e.tabs=e.tabs||[];e.tabs.forEach((e,r)=>{c[u].tabs[r]={id:e.id||uuid(),icon:e.icon||"mdi-tab",title:e.title,iconColor:"",color:"",backgroundColor:"",widgetConfig:{},widgetsDesktop:[],widgetsTablet:[],widgetsSmartphone:[],widgetEdges:e.widgetsEdges!==undefined?e.widgetsEdges:false};e.columns=e.columns||[];const d=Math.floor(12/e.columns.length);let l=0;e.columns=e.columns||[];e.columns.forEach((e,a)=>{e=e||[];l=0;e.forEach((e,t)=>{if(e){const i=e.devices?e.devices.map(s=>{s.id=uuid();const o={};for(const n in s){if(n.endsWith("Config")){o[n]={};for(const a in s[n]){let[e,t]=a.split("-");let i=s[n][a];o[n][e]=o[n][e]||{};if(n==="ButtonActionConfig"&&t==="label"){t="labelTurnOn";o[n][e].labelTurnOff=i}if((n==="IconButtonActionConfig"||n==="ButtonActionConfig")&&t==="buttonSize"){i=i===true?"sm":"md"}else if((n==="IconButtonActionConfig"||n==="ButtonActionConfig")&&t==="icon"){t="iconTurnOn";o[n][e].iconTurnOff=i}o[n][e][t]=i}}}s={...s,...o};if(s.type==="group"){s.groupElement=s.actionElement;delete s.actionElement;delete s.bodyStateKey;delete s.bodyElement}if(s.type==="device"&&s.bodyElement!==null){s.bodyStateKey=s.bodyStateKey||s.primaryStateKey;if(s.bodyStateKey){s.bodyElement=s.bodyElement||"LastChangeBody";s.bodyElement=s.bodyElement==="LightTemperatureBody"?"LevelBody":s.bodyElement}}return s}):[];e.module=e.module==="Chart"?"HistoryGraph":e.module;e.module=e.module==="CustomHTML"?"StateHTML":e.module;if(e.module==="StateListHorizontal"){e.module="StateList";e.moduleConfig={...e.moduleConfig||{},horizontal:true,stacked:true}}const{height:n,scaleToFitContents:s}=ioBroker.getDefaultModuleHeight(e,i);const o=uuid();e.hideTitle=e.fullscreen!==undefined?e.fullscreen:!e.title;m[o]={id:o,config:e.moduleConfig||{},icon:e.icon||"mdi:home",title:e.title||"",module:e.module,items:i||[],hideTitle:e.hideTitle,hideSeparator:true};c[u].tabs[r].widgetsDesktop.push({x:a*d,y:l,w:d,h:n,i:uuid(),items:[o],scaleToFitContents:s,alignmentVertical:"top",alignmentHorizontal:"center"});l+=n}})})})});return Promise.allSettled([new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3,signature:hash(c),layout:c}),true,e=>e?i({key:n,version:2}):t({key:n,version:3}))}),new Promise((t,i)=>{this.adapter.setState("widgets",JSON.stringify({version:3,signature:hash(m),widgets:m}),true),e=>e?i({key:n,version:2}):t({key:n,version:3})})]).then(e=>{if(e.some(e=>e.status==="rejected")){return{key:n,version:2}}return{key:n,version:3}})},v2widgets(n,e){const s=e.val||{};return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3,signature:hash(s),widgets:s}),true,e=>e?i({key:n,version:2}):t({key:n,version:3}))})},v3widgets(n,e){const s=e.val&&e.val.widgets||{};for(const t in s){const i=s[t];const o=i.items||[];s[t].items=o.map(e=>{if(e.bodyStateKey&&(e.bodyElement===undefined||e.bodyElement==="")){e.bodyElement=null}return e})}return new Promise((t,i)=>{this.adapter.setState(e._id,JSON.stringify({version:3.1,signature:hash(s),widgets:s}),true,e=>e?i({key:n,version:2}):t({key:n,version:3.1}))})}};