const{encrypt}=require("./encryption");const{format}=require("date-fns");const axios=require("axios");const fs=require("fs");const os=require("os");const path=require("path");module.exports={getConfig({cb:e}){e({config:this.adapter.config})},getGroups(){return new Promise(r=>{this.adapter.getObjectView("system","group",null,(e,t)=>{if(e||!t){return reject(e)}r(t.rows)})})},getLogs({cb:t},u={}){this.adapter.log.debug("Get logs with options: "+JSON.stringify(u));let e=u.date;if(!e){const i=new Date;e=i.getFullYear()+"-"+("0"+(i.getMonth()+1)).substr(-2)+"-"+("0"+i.getDate()).substr(-2)}const r=this.adapter.systemConfig.log.transport.file1;const s=path.resolve(this.adapter.systemConfig.dataDir+"../"+r.filename+"."+e+""+r.fileext);const l=[];fs.readFile(s,"utf-8",(e,r)=>{if(e){return t({err:e})}const s=r.substr(0,4);let i=0;r=r.split("\n"+s).reverse();for(let t of r){t=i?s+t:t;const a=new Date(t.substr(0,23)).getTime();const n=["silly","debug","info","warn","error"].find(e=>t.indexOf(e)!==-1);const o=t.indexOf(": ")+2;const c=t.substr(o).indexOf("host")===-1?t.substr(o,t.indexOf(" (")-o):t.substr(o,t.indexOf(" ",o)-o);let e=t.substr(o).replace(/(?:\r\n|\r|\n)/g," ").replace(c+" ","");e=t.substr(o).indexOf("host")===-1?e.substr(e.indexOf(") ")+2):e;l.push({from:c,ts:a,severity:n,message:e});i++;if(u.rowsMaxTotal&&i===u.rowsMaxTotal){break}}t({err:null,logs:l})})},getObject({cb:r},s){this.adapter.getForeignObject(s,(e,t)=>{e=e||t===null&&"Object empty";t=t===null?null:{...t||{},id:s};r({err:e,object:t})})},getObjects({cb:t},s){let r=[];["device","channel","state"].forEach(e=>{r.push(new Promise(r=>{this.adapter.getForeignObjects(s||"*",e,(e,t)=>r({err:e,objects:t}))}))});let i=null;let a={};Promise.all(r).then(e=>{e.forEach(e=>{i=i||e.err;a={...a,...e.objects}});Object.keys(a).forEach(e=>{delete a[e].acl;const t=e.substr(0,e.indexOf(".",e.indexOf(".")+1));if(t&&!a[t]){a[t]={_id:t,type:"adapter"}}if(e.indexOf("system.adapter")>-1||e.indexOf("system.host")>-1||e.indexOf(".")===-1){delete a[e]}});t({err:i,objects:a})})},getObjectView({cb:r},e,t,s){this.adapter.getObjectView(e,t,s,(e,t)=>{r({err:e,objects:t&&t.rows||[]})})},getRooms({cb:t}){this.adapter.getEnums("rooms",(e,r)=>{if(e){t({err:e,rooms:{}});return}const s={};Object.keys(r["enum.rooms"]).map(e=>{const t=r["enum.rooms"][e];s[e.replace("enum.rooms.","").toLowerCase()]={members:t.common.members||[],name:t.common.name||"",id:e}});t({err:e,rooms:s})})},getState({cb:r,clientId:e},s,t={}){t=t||{};const i=this.clients[e]||{};this.adapter.getForeignState(s,{...t,user:t.user||i.userId||this.options.user},(e,t)=>{if(!e&&!t){e=new Error(s+" is not a valid state (in getState)")}t=!t?null:{...t,id:s};r({err:e,stateId:s,state:t})})},getStates({cb:r,clientId:e},t,s={}){s=s||{};const i=this.clients[e]||{};this.adapter.getForeignStates(t,{...s,user:s.user||i.userId||this.options.user},(e,t)=>{r({err:e,states:t})})},getSystemInformation({cb:e}){e({hostname:os.hostname(),architecture:os.arch(),platform:os.platform(),release:os.release()})},getTime({cb:e}){e(Date.now())},getUsers(a=false){const e=a?this.getGroups():Promise.resolve();return e.then(i=>{return new Promise((r,s)=>{this.adapter.getObjectView("system","user",null,(e,t)=>{if(e||!t){return s(e)}r(!a?t.rows:t.rows.map(t=>{t.value.groups=i.filter(e=>e.value.common.members.includes(t.value.user));return t}))})})})},getWeather({cb:r},s,e){this.adapter.log.debug("Get weather with options: "+JSON.stringify(e));if(s==="wetter.com"){return this.request({cb:r},{url:"http://api.daswetter.com/index.php?v=3.0&api_lang="+e.language+"&localidad="+e.localid+"&affiliate_id="+e.apikey,responseType:"json"}).then(e=>{e.day=Object.values(e.day);this.subscribedWeather[s].err=null;this.subscribedWeather[s].weather=e;r(this.subscribedWeather[s])}).catch(e=>{this.subscribedWeather[s].err=e;this.subscribedWeather[s].weather=null;r(this.subscribedWeather[s])})}else if(s==="openweathermap"){const i=(t,e)=>{e=e.filter(e=>e.dt_txt.startsWith(format(t.dt*1e3,"yyyy-MM-dd")));return{...t,date:format(t.dt*1e3,"yyyyMMdd"),temp:t.temp.day,windchill:t.feels_like.day,tempmax:t.temp.max,tempmin:t.temp.min,pressure:t.pressure,units:{temp:"°C",wind:"km/h",rain:"mm",pressure:"mb",snowline:"m"},rain:t.rain||0,symbol_value:t.weather[0].icon,wind:{dir:t.wind_deg,speed:t.wind_speed,gusts:t.wind_gust},hour:e.map(e=>({interval:e.dt_txt,symbol_value:e.weather[0].icon,symbol_description:e.weather[0].description,temp:e.main.temp,units:{temp:"°C",wind:"km/h",rain:"mm"},rain:(typeof e.rain==="object"?Object.values(e.rain).reduce((e,t)=>e+t,0):e.rain)||0,clouds:e.clouds.all+"%",wind:{dir:e.wind.deg,speed:e.wind.speed,gusts:e.wind.gust}}))}};const t="https://api.openweathermap.org/data/";const a={lat:e.latitude,lon:e.longitude,appid:e.apikey,units:e.units||"metric",lang:e.language};return Promise.allSettled([this.request(null,{url:t+"3.0/onecall?exclude=minutely,hourly&"+new URLSearchParams(a).toString(),responseType:"json"}),this.request(null,{url:t+"2.5/forecast?"+new URLSearchParams(a).toString(),responseType:"json"})]).then(t=>{if(!t||!t[0]||!t[1]||t[0].reason||t[1].reason){this.subscribedWeather[s].err=new Error(t&&(t[0]||t[1])?t[0].reason||t[1].reason:"Unknown error");this.subscribedWeather[s].weather=null;return r(this.subscribedWeather[s])}this.subscribedWeather[s].err=null;this.subscribedWeather[s].weather={day:t[0].value.daily.slice(0,5).map(e=>i(e,t[1].value.list))};r(this.subscribedWeather[s])})}this.subscribedWeather[s].err=new Error("Unknown Weather Service!");this.subscribedWeather[s].weather=null;r(this.subscribedWeather[s])},readFile({cb:r},e){e=path.resolve(e.replace("{dirname}",__dirname));fs.readFile(e,"utf-8",(e,t)=>{r({err:e,data:t})})},request(t,r={}){t=t||{};try{if(r._encrypt&&r.body.data){r.data=encrypt(r.body.data,"KutTGsNQ8HCX$hrT9Ua5beRSs2BLVeQq");delete r._encrypt}return axios(r).then(e=>{t.cb&&t.cb({_options:r,data:e.data||""});return e.data}).catch(e=>{this.adapter.log.warn("Warning requesting data from "+r.url+": "+e.message);t.cb&&t.cb({err:e});return e})}catch(e){this.adapter.log.warn("Warning requesting data from "+r.url+": "+e.message);t.cb&&t.cb({err:e});return Promise.reject(e)}},subscribeState({cb:e,clientId:t},r){this.subscribedStates[r]=this.subscribedStates[r]||{};this.subscribedStates[r][t]=true;this.getState({cb:e},r)},subscribeLog({cb:e,clientId:t},r){this.subscribedLog[t]=true;if(r.getInitialLogs){return this.getLogs({cb:e},r)}e({err:null,logs:[]})},subscribeWeather({cb:e,clientId:t},r,s){if(!this.subscribedWeather[r]){this.subscribedWeather[r]={subscriptionKey:r,options:{...s},clients:[t]};return this.getWeather({cb:e},r,{...s})}else if(!this.subscribedWeather[r].clients.includes(t)){this.subscribedWeather[r].clients.push(t)}e(this.subscribedWeather[r])}};